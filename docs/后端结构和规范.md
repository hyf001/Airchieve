# 项目结构和编码规范

## 目录结构

```
app/
├── __init__.py
├── main.py                 # FastAPI 应用入口
├── api/                    # API 路由层
│   ├── __init__.py
│   ├── deps.py             # 公共依赖（认证拦截等）
│   └── v1/                 # API 版本 v1
│       ├── __init__.py
│       ├── router.py       # 路由聚合
│       ├── user_api.py     # 用户相关接口
│       ├── projects_api.py # 项目相关接口
│       └── chat_api.py     # 聊天相关接口（SSE 流式）
├── core/                   # 核心模块
│   ├── __init__.py
│   ├── config.py           # 配置管理
│   ├── security.py         # JWT Token 工具函数
│   ├── agent_manager.py    # 智能体会话管理（统一入口）
│   ├── airchieve_agent.py  # Claude Agent SDK 实现
│   ├── ChatMessage.py      # 系统消息结构体
│   ├── chat_context.py     # 聊天上下文封装
│   ├── message_handler.py  # 消息处理器
│   └── utils/              # 工具函数
│       ├── terminal_ui.py
│       └── prompt_util.py
├── db/                     # 数据库模块
│   ├── __init__.py
│   ├── base.py             # SQLAlchemy Base 基类
│   └── session.py          # 数据库会话管理
├── models/                 # 数据库模型 (ORM)
│   ├── __init__.py
│   ├── user.py             # 用户模型
│   ├── projects.py         # 项目模型
│   └── user_query.py       # 用户问句模型
├── schemas/                # Pydantic 数据模式
│   ├── __init__.py
│   └── media.py            # 文件信息模型
└── services/               # 业务逻辑层
    ├── project_service.py  # 项目服务
    └── chat_service.py     # 聊天服务
```

## 配置文件

```
项目根目录/
├── .env                    # 环境变量 (敏感配置，不提交到 Git)
├── .gitignore              # Git 忽略文件
├── requirements.txt        # Python 依赖
└── docs/                   # 文档目录
```

---

## 核心模块说明

### 认证拦截器

所有业务接口统一通过 `app/api/deps.py` 中的 `get_current_user` 依赖进行认证拦截。

**认证流程：**
1. 客户端请求携带 `Authorization: Bearer <jwt_token>`
2. `get_current_user` 解析 JWT Token，从 `sub` 字段取出 `user_id`
3. 查库验证用户存在，返回 `User` 对象
4. 认证失败返回 `401 Unauthorized`

**Token payload 约定：** `{"sub": user_id}`

**使用方式：**
```python
from app.api.deps import get_current_user
from app.models.user import User

@router.get("/xxx")
async def xxx(user: User = Depends(get_current_user)):
    # user.id 即当前认证用户ID
    ...
```

### 智能体调用链路

```
chat_api (SSE 流式接口)
  → chat_service (业务逻辑)
    → agent_manager (会话管理，创建 Agent + Context)
      → airchieve_agent (Claude Agent SDK 执行)
        → 流式返回 ChatMessage
```

**ChatMessage 结构体：**
```python
class ChatMessage(BaseModel):
    role: str               # 角色
    message_type: str       # 消息类型
    content: str            # 内容
    metadata_json: dict | None  # 元数据
    conversation_id: str    # 会话ID
    duration_ms: int        # 耗时
    token_count: int        # Token 消耗
    cost_usd: float | None  # 费用
    created_at: datetime    # 时间戳
```

---

## 编码规范

### 1. 文件命名

| 类型 | 规范 | 示例 |
|------|------|------|
| 模块文件 | 小写下划线 | `user_query.py` |
| 类名 | 大驼峰 | `UserQuery` |
| 函数/变量 | 小写下划线 | `get_user_by_id` |
| 常量 | 大写下划线 | `DATABASE_URL` |

### 2. 数据库模型规范

```python
"""
Model Name
模型中文描述
"""
from datetime import datetime
from typing import TYPE_CHECKING, List

from sqlalchemy import String, DateTime, Integer, ForeignKey
from sqlalchemy.orm import Mapped, mapped_column, relationship

from app.db.base import Base

if TYPE_CHECKING:
    from app.models.other_model import OtherModel


class ExampleModel(Base):
    """模型中文说明"""
    __tablename__ = "example"  # 表名使用单数形式

    # 主键标识
    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)

    # 外键关联
    user_id: Mapped[int] = mapped_column(
        Integer,
        ForeignKey("user.id", ondelete="CASCADE"),
        index=True,
        nullable=False
    )  # 字段中文说明

    # 普通字段
    name: Mapped[str] = mapped_column(String(128), nullable=False)  # 名称
    created_at: Mapped[datetime] = mapped_column(DateTime, nullable=False)  # 创建时间

    # 关联关系
    user: Mapped["User"] = relationship("User", back_populates="examples")
```

**要点：**
- 表名使用**单数形式**（`user` 而非 `users`）
- 使用 `Mapped[]` 类型注解
- 外键使用 `ondelete="CASCADE"`
- 字段注释使用行内注释
- 使用 `TYPE_CHECKING` 避免循环导入

### 3. API 路由规范

```python
"""
API Name
API 中文描述
"""
from fastapi import APIRouter, Depends
from sqlalchemy.ext.asyncio import AsyncSession

from app.api.deps import get_current_user
from app.db.session import get_db
from app.models.user import User

router = APIRouter()


@router.get("/{item_id}")
async def get_item(
    item_id: int,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db),
):
    """获取项目信息"""
    # user.id 为当前认证用户
    pass
```

**要点：**
- 所有业务接口必须添加 `get_current_user` 依赖进行认证
- 用户信息从 Token 中获取，不从请求参数传入

### 4. Service 层规范

```python
"""
Service Name
服务中文描述
"""
from typing import AsyncGenerator

from sqlalchemy.ext.asyncio import AsyncSession


async def do_something(param: str, db: AsyncSession) -> Result:
    """函数中文说明"""
    # 业务逻辑
    pass
```

**要点：**
- Service 层为纯函数/异步生成器，不依赖类实例
- 数据库操作通过传入的 `db: AsyncSession` 完成
- 流式场景使用 `AsyncGenerator` 返回类型

### 5. 配置管理规范

**敏感配置**放入 `.env` 文件：
```env
DATABASE_URL=sqlite+aiosqlite:///data/app.db
SECRET_KEY=your-secret-key
GEMINI_API_KEY=sk-xxx
ANTHROPIC_AUTH_TOKEN=xxx
```

**config.py** 使用 pydantic-settings：
```python
class Settings(BaseSettings):
    model_config = SettingsConfigDict(
        env_file=".env",
        env_file_encoding="utf-8",
    )

    DATABASE_URL: str = ""  # 默认值为空，从 .env 读取
```

### 6. 注释规范

- 文件头部使用三引号文档字符串，包含英文名和中文描述
- 类和函数使用中文文档字符串
- 行内注释使用中文

```python
"""
User Model
用户信息模型
"""

class User(Base):
    """用户信息表"""

    name: Mapped[str] = mapped_column(String(128))  # 用户名称
```

### 7. 导入顺序

```python
# 1. 标准库
from datetime import datetime
from typing import List, Optional

# 2. 第三方库
from fastapi import APIRouter
from sqlalchemy.orm import Mapped

# 3. 本地模块
from app.db.base import Base
from app.core.config import settings
```

---

## 数据库设计

### 表关系

```
User (用户)
 ├── 1:N → Project (项目)
 └── 1:N → UserQuery (问句)

Project (项目)
 └── 1:N → UserQuery (问句)
```

### 命名规则

| 类型 | 规则 | 示例 |
|------|------|------|
| 表名 | 单数小写 | `user`, `project` |
| 主键 | `id` | `id` |
| 外键 | `{表名}_id` | `user_id`, `project_id` |
| 时间戳 | `{动作}_at` | `created_at`, `updated_at` |

---

## API 接口一览

| 方法 | 路径 | 说明 | 认证 |
|------|------|------|------|
| GET | `/api/v1/ping` | 健康检查 | 否 |
| GET | `/health` | 健康检查 | 否 |
| POST | `/api/v1/projects` | 创建项目 | Bearer Token |
| GET | `/api/v1/projects` | 分页查询项目列表 | Bearer Token |
| POST | `/api/v1/chat/stream` | 流式聊天（SSE） | Bearer Token |

---

## 依赖清单

| 包名 | 用途 |
|------|------|
| fastapi | Web 框架 |
| uvicorn | ASGI 服务器 |
| pydantic / pydantic-settings | 数据验证与配置 |
| SQLAlchemy | ORM |
| aiosqlite | SQLite 异步驱动（开发） |
| aiomysql | MySQL 异步驱动（生产） |
| python-jose[cryptography] | JWT Token 签发与验证 |
| httpx / requests | HTTP 客户端 |
| python-dotenv | 环境变量加载 |

---

## 环境配置

### 开发环境

```bash
# 创建虚拟环境
python3.12 -m venv .venv
source .venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 启动服务
uvicorn app.main:app --reload --port 8000
```

### 数据库配置

| 环境 | 驱动 | 连接字符串示例 |
|------|------|----------------|
| 开发 | SQLite | `sqlite+aiosqlite:///data/app.db` |
| 生产 | MySQL | `mysql+aiomysql://user:pass@host:3306/db` |
